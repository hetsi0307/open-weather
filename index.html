<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather Map ‚Äî iOS Glass Style</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>

  <style>
    /* ---------- Base ---------- */
    :root{
      --glass-bg: rgba(255,255,255,0.75);
      --glass-border: rgba(255,255,255,0.45);
      --accent-1: #66b2ff;
      --accent-2: #1e90ff;
      --accent-3: #00c49a;
      --muted: #69707a;
      --card-radius: 22px;
      --shadow-1: 0 10px 30px rgba(16,24,40,0.12);
      --glass-glow: 0 6px 30px rgba(30,144,255,0.08);
      --map-overlay-opacity: 0.82;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,#f6fbff 0%, #f1f7fb 100%); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; overflow:hidden}

    /* ---------- Map ---------- */
    #map {
      position:fixed;
      inset:0;
      z-index:1;
      filter: saturate(0.98) contrast(0.98);
    }
    .leaflet-container { height:100%; width:100%; }

    /* subtle blurred overlay on map edges for more premium look */
    .map-gradient-top,
    .map-gradient-bottom {
      position:fixed; left:0; right:0; height:14vh; z-index:2; pointer-events:none;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0));
      mix-blend-mode: lighten;
    }
    .map-gradient-bottom { top:auto; bottom:0; transform: rotate(180deg); opacity:0.85 }

    /* ---------- Floating weather card (iOS Glass) ---------- */
    .weather-card {
      position:fixed;
      right: clamp(18px, 6vw, 48px);
      top: 50%;
      transform: translateY(-50%);
      z-index: 999;
      width: min(460px, 90vw);
      background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(250,250,250,0.78));
      border-radius: var(--card-radius);
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-1), var(--glass-glow);
      padding: 26px;
      backdrop-filter: blur(18px) saturate(1.05);
      transition: transform .35s cubic-bezier(.2,.9,.2,1), box-shadow .25s ease;
      overflow: hidden;
    }
    .weather-card:focus-within { transform: translateY(-52%); box-shadow: 0 18px 50px rgba(16,24,40,0.18), 0 8px 30px rgba(30,144,255,0.06); }

    /* Header */
    .wc-head {
      display:flex; align-items:center; gap:12px; margin-bottom:8px;
    }
    .app-icon {
      width:54px; height:54px; border-radius:14px;
      background: linear-gradient(135deg,var(--accent-1),var(--accent-2));
      display:flex; align-items:center; justify-content:center; color:white; font-size:22px;
      box-shadow: 0 6px 18px rgba(30,144,255,0.18), inset 0 -6px 14px rgba(255,255,255,0.06);
      flex-shrink:0;
    }
    .wc-title {
      font-weight:700; font-size:20px; letter-spacing: -0.3px; color:#153243;
    }
    .wc-sub { font-size:12px; color:var(--muted); margin-top:2px; }

    /* Search row */
    .search-row { display:flex; gap:12px; margin-top:12px; align-items:center; }
    .input-wrap {
      flex:1; position:relative;
    }
    input#cityInput {
      width:100%; padding:12px 14px 12px 44px; border-radius:14px; border:1px solid rgba(20,30,40,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.9));
      font-size:15px; outline:none; color:#153243; box-shadow: 0 6px 18px rgba(16,24,40,0.04) inset;
    }
    .search-icon {
      position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:0.9;
      font-size:16px; color:var(--accent-2);
    }
    .btn {
      padding:10px 14px; border-radius:12px; border:none; cursor:pointer; font-weight:600;
      background: linear-gradient(180deg,var(--accent-1),var(--accent-2)); color:white; box-shadow: 0 8px 20px rgba(30,144,255,0.18);
    }
    .btn:active { transform: translateY(1px) }

    .secondary {
      background: linear-gradient(180deg,#fff,#f7fbff);
      border:1px solid rgba(16,24,40,0.06);
      color:var(--accent-2); box-shadow: none; font-weight:700;
    }

    /* Current location button (full width) */
    .location-btn {
      display:block; margin:16px 0 4px 0; width:100%; padding:12px; border-radius:14px;
      background: linear-gradient(90deg,#e8fbf6, rgba(255,255,255,0.9));
      border:1px solid rgba(0,196,150,0.12); color:var(--accent-3); font-weight:700;
      box-shadow: 0 6px 20px rgba(0,196,150,0.07);
    }

    /* Weather main */
    .weather-main { text-align:center; padding: 18px 4px 8px 4px; }
    .city-name { font-size:22px; font-weight:700; color:#0f2430; margin-bottom:10px; }
    .temp-row { display:flex; align-items:center; justify-content:center; gap:18px; }
    .temp-value { font-size:56px; font-weight:800; color:var(--accent-2); line-height:1; }
    .temp-unit { font-size:18px; color:var(--muted); margin-top:8px; }
    .weather-emoji {
      font-size:46px; width:86px; height:86px; display:flex; align-items:center; justify-content:center;
      border-radius:18px; background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(250,250,255,0.6));
      box-shadow: 0 8px 26px rgba(9,132,227,0.08), inset 0 -6px 12px rgba(255,255,255,0.6);
    }
    .condition { font-size:15px; color:var(--muted); margin-top:10px; font-weight:600; }

    /* Details grid */
    .details-grid { margin-top:18px; display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    .detail {
      padding:12px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(246,251,255,0.7));
      border:1px solid rgba(16,24,40,0.03); text-align:center;
    }
    .detail .label { font-size:12px; color:var(--muted); }
    .detail .val { margin-top:6px; font-weight:700; color:#0f2430; font-size:16px; }

    /* footer small actions */
    .card-footer { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:18px; }
    .unit-toggle { display:flex; gap:8px; align-items:center; background:transparent; border-radius:10px; padding:6px; }
    .unit-toggle button { border:none; background:transparent; padding:6px 10px; font-weight:700; border-radius:10px; cursor:pointer; color:var(--muted); }
    .unit-toggle button.active { color:var(--accent-2); background:linear-gradient(90deg, rgba(30,144,255,0.08), rgba(30,144,255,0.03)); }

    /* loading / error */
    .loading { display:flex; gap:8px; align-items:center; justify-content:center; color:var(--accent-2); font-weight:700; margin-top:12px; }
    .dot { width:8px; height:8px; border-radius:999px; background:var(--accent-2); opacity:.12; animation: blink 1s infinite; }
    .dot:nth-child(2){ animation-delay:.15s; opacity:.22 }
    .dot:nth-child(3){ animation-delay:.3s; opacity:.3 }
    @keyframes blink { 0%{opacity:.12} 50%{opacity:1} 100%{opacity:.12} }

    .error { margin-top:12px; background:linear-gradient(90deg,#ffece9,#fff8f8); border:1px solid rgba(255,110,100,0.1); color:#d0423f; padding:10px; border-radius:10px; text-align:center; font-weight:700; }

    /* map marker style (tiny floating glass) */
    .weather-marker {
      display:flex; align-items:center; justify-content:center; width:54px; height:54px; border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(245,250,255,0.88));
      border: 2px solid white; box-shadow: 0 8px 26px rgba(16,24,40,0.12);
      font-size:22px;
    }

    /* popup style ‚Äî match card */
    .leaflet-popup-content-wrapper { border-radius:14px; box-shadow: var(--shadow-1); border:1px solid var(--glass-border); }
    .leaflet-popup-content { font-family:inherit; padding:14px; text-align:center; color:#0f2430; }
    .leaflet-popup-content h3{ margin:0 0 8px 0; font-size:16px; font-weight:800 }
    .leaflet-popup-content .popup-temp { font-weight:800; color:var(--accent-2); font-size:20px; margin-top:6px; }

    /* responsive */
    @media (max-width:840px){
      .weather-card { right: 8px; left:8px; width: calc(100% - 16px); top: auto; bottom: 6vh; transform: translateY(0); }
      .map-gradient-top, .map-gradient-bottom { display:none; }
    }
  </style>
</head>
<body>
  <!-- Map -->
  <div id="map" aria-hidden="false"></div>
  <div class="map-gradient-top" aria-hidden="true"></div>
  <div class="map-gradient-bottom" aria-hidden="true"></div>

  <!-- Weather overlay card (iOS glass) -->
  <section class="weather-card" role="region" aria-label="Weather information">
    <div class="wc-head" aria-hidden="false">
      <div class="app-icon" aria-hidden="true">‚òÅÔ∏è</div>
      <div>
        <div class="wc-title">Weather Map</div>
        <div class="wc-sub">Beautiful glassy view ‚Äî tap the map or search a city</div>
      </div>
    </div>

    <button class="location-btn" id="locBtn" title="Use current location">üìç Use current location</button>

    <div class="search-row" role="search">
      <div class="input-wrap">
        <span class="search-icon">üîé</span>
        <input id="cityInput" placeholder="Search city (e.g., Vadodara) ‚Äî press Enter" aria-label="Search city" maxlength="60" />
      </div>
      <button class="btn" id="searchBtn" title="Search city">Search</button>
    </div>

    <div id="loading" class="loading" aria-live="polite" style="display:none;margin-top:12px;">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      <div style="margin-left:8px">Fetching weather...</div>
    </div>

    <div id="error" class="error" style="display:none"></div>

    <div id="weatherInfo" style="display:none">
      <div class="weather-main">
        <div class="city-name" id="cityName">City, Country</div>

        <div class="temp-row">
          <div class="weather-emoji" id="weatherIcon">üå§Ô∏è</div>
          <div style="text-align:left">
            <div class="temp-value" id="temperature">24¬∞</div>
            <div class="temp-unit" id="tempUnit">Feels like 25¬∞ ¬∑ Light rain</div>
          </div>
        </div>

        <div class="condition" id="condition">Condition text</div>
      </div>

      <div class="details-grid" aria-hidden="false">
        <div class="detail">
          <div class="label">Feels like</div>
          <div class="val" id="feelsLike">‚Äî</div>
        </div>
        <div class="detail">
          <div class="label">Humidity</div>
          <div class="val" id="humidity">‚Äî</div>
        </div>
        <div class="detail">
          <div class="label">Wind</div>
          <div class="val" id="windSpeed">‚Äî</div>
        </div>
        <div class="detail">
          <div class="label">Pressure</div>
          <div class="val" id="pressure">‚Äî</div>
        </div>
      </div>

      <div class="card-footer">
        <div class="unit-toggle" role="tablist" aria-label="Units">
          <button id="metricBtn" class="active" aria-pressed="true">¬∞C</button>
          <button id="imperialBtn" aria-pressed="false">¬∞F</button>
        </div>
        <div style="font-size:13px;color:var(--muted)">Tap map to pick a location</div>
      </div>
    </div>
  </section>

  <!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

  <script>
    // ----------------- App class (cleaner & modular) -----------------
    class WeatherMapApp {
      constructor() {
        // Your OpenWeather API key (replace if needed)
        this.apiKey = '4fdf35fd80817e74c068dadcb4efec14';
        this.baseUrl = 'https://api.openweathermap.org/data/2.5/weather';
        this.units = 'metric'; // 'metric' or 'imperial'

        // UI refs
        this.mapEl = document.getElementById('map');
        this.cityInput = document.getElementById('cityInput');
        this.searchBtn = document.getElementById('searchBtn');
        this.locBtn = document.getElementById('locBtn');
        this.loadingEl = document.getElementById('loading');
        this.errorEl = document.getElementById('error');
        this.weatherInfoEl = document.getElementById('weatherInfo');

        this.cityNameEl = document.getElementById('cityName');
        this.weatherIconEl = document.getElementById('weatherIcon');
        this.temperatureEl = document.getElementById('temperature');
        this.tempUnitEl = document.getElementById('tempUnit');
        this.conditionEl = document.getElementById('condition');
        this.feelsLikeEl = document.getElementById('feelsLike');
        this.humidityEl = document.getElementById('humidity');
        this.windSpeedEl = document.getElementById('windSpeed');
        this.pressureEl = document.getElementById('pressure');

        this.metricBtn = document.getElementById('metricBtn');
        this.imperialBtn = document.getElementById('imperialBtn');

        this.map = null;
        this.marker = null;

        this.init();
      }

      init() {
        this.initMap();
        this.bindUI();
        // show an initial city
        this.getWeatherByCity('Vadodara');
      }

      initMap() {
        this.map = L.map('map', { zoomControl: true }).setView([22.3072, 73.1812], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(this.map);

        // click map => fetch weather for coords
        this.map.on('click', e => {
          this.getWeatherByCoords(e.latlng.lat, e.latlng.lng);
        });
      }

      bindUI() {
        this.searchBtn.addEventListener('click', () => this.getWeather());
        this.locBtn.addEventListener('click', () => this.getCurrentLocation());
        this.cityInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') this.getWeather();
        });

        this.metricBtn.addEventListener('click', () => this.setUnit('metric'));
        this.imperialBtn.addEventListener('click', () => this.setUnit('imperial'));
      }

      setUnit(u) {
        if (this.units === u) return;
        this.units = u;
        this.metricBtn.classList.toggle('active', u === 'metric');
        this.imperialBtn.classList.toggle('active', u === 'imperial');
        this.metricBtn.setAttribute('aria-pressed', u === 'metric');
        this.imperialBtn.setAttribute('aria-pressed', u === 'imperial');

        // re-fetch current input/city if available
        const city = this.cityInput.value.trim();
        if (city) this.getWeatherByCity(city);
      }

      // show/hide helpers
      showLoading(){ this.loadingEl.style.display = 'flex'; }
      hideLoading(){ this.loadingEl.style.display = 'none'; }
      showError(msg){ this.errorEl.textContent = msg; this.errorEl.style.display = 'block'; }
      hideError(){ this.errorEl.style.display = 'none'; }
      showWeather(){ this.weatherInfoEl.style.display = 'block'; }
      hideWeather(){ this.weatherInfoEl.style.display = 'none'; }

      async getWeather() {
        const city = this.cityInput.value.trim();
        if (!city) { this.showError('Please enter a city name.'); return; }
        await this.getWeatherByCity(city);
      }

      async getWeatherByCity(city) {
        if (!this.apiKey) { this.showError('API key missing. Add your OpenWeather key.'); return; }
        this.hideError(); this.showLoading(); this.hideWeather();

        try {
          const url = `${this.baseUrl}?q=${encodeURIComponent(city)}&appid=${this.apiKey}&units=${this.units}`;
          const resp = await fetch(url);
          if (!resp.ok) {
            const json = await resp.json().catch(()=>({}));
            throw new Error(json.message || 'Failed to fetch');
          }
          const data = await resp.json();
          this.renderWeather(data);
          this.updateMapMarker(data.coord.lat, data.coord.lon, data);
        } catch (err) {
          this.showError(this.friendlyError(err.message));
        } finally {
          this.hideLoading();
        }
      }

      async getWeatherByCoords(lat, lon) {
        if (!this.apiKey) { this.showError('API key missing. Add your OpenWeather key.'); return; }
        this.hideError(); this.showLoading(); this.hideWeather();

        try {
          const url = `${this.baseUrl}?lat=${lat}&lon=${lon}&appid=${this.apiKey}&units=${this.units}`;
          const resp = await fetch(url);
          if (!resp.ok) {
            const json = await resp.json().catch(()=>({}));
            throw new Error(json.message || 'Failed to fetch');
          }
          const data = await resp.json();
          this.renderWeather(data);
          this.updateMapMarker(lat, lon, data);
          this.cityInput.value = data.name || this.cityInput.value;
        } catch (err) {
          this.showError(this.friendlyError(err.message));
        } finally {
          this.hideLoading();
        }
      }

      friendlyError(msg){
        const lower = (msg || '').toLowerCase();
        if (lower.includes('city not found')) return 'City not found ‚Äî check spelling.';
        if (lower.includes('invalid api key')) return 'Invalid API key ‚Äî please check it.';
        return 'Unable to fetch weather. Try again later.';
      }

      // Render into card
      renderWeather(data) {
        if (!data) return;
        const temp = Math.round(data.main.temp);
        const feels = Math.round(data.main.feels_like);
        const hum = data.main.humidity;
        const wind = Math.round((data.wind.speed || 0) * (this.units === 'metric' ? 3.6 : 1)); // m/s -> km/h for metric, mph for imperial keep approx
        const press = data.main.pressure;
        const cond = data.weather[0].description;
        const main = data.weather[0].main;

        this.cityNameEl.textContent = `${data.name}, ${data.sys.country}`;
        this.temperatureEl.textContent = `${temp}¬∞`;
        this.tempUnitEl.textContent = `Feels like ${feels}¬∞ ¬∑ ${this.capitalize(cond)}`;
        this.conditionEl.textContent = this.capitalize(cond);
        this.weatherIconEl.textContent = this.getEmoji(main);
        this.feelsLikeEl.textContent = `${feels}¬∞`;
        this.humidityEl.textContent = `${hum}%`;
        this.windSpeedEl.textContent = this.units === 'metric' ? `${wind} km/h` : `${wind} mph`;
        this.pressureEl.textContent = `${press} hPa`;

        this.showWeather();
      }

      updateMapMarker(lat, lon, weatherData) {
        // remove previous
        if (this.marker) this.map.removeLayer(this.marker);

        // fly to view
        this.map.flyTo([lat, lon], Math.max(this.map.getZoom(), 11), { animate: true, duration: 1.6 });

        // marker element (styled)
        const emoji = this.getEmoji(weatherData.weather[0].main);
        const el = document.createElement('div');
        el.className = 'weather-marker';
        el.innerHTML = `<div style="font-size:22px;">${emoji}</div>`;

        this.marker = L.marker([lat, lon], { icon: L.divIcon({ className: '', html: el.outerHTML, iconSize: [54,54], iconAnchor: [27,27] }) })
          .addTo(this.map)
          .bindPopup(`<div style="text-align:center;">
                        <h3>${weatherData.name}</h3>
                        <div style="font-size:28px;margin:10px 0">${emoji}</div>
                        <div class="popup-temp">${Math.round(weatherData.main.temp)}¬∞C</div>
                        <div style="color:#6b7280;font-style:italic;margin-top:6px;">${this.capitalize(weatherData.weather[0].description)}</div>
                      </div>`);

        // open popup gently
        setTimeout(()=>{ if (this.marker) this.marker.openPopup(); }, 650);
      }

      getEmoji(main) {
        const map = {
          Clear: '‚òÄÔ∏è', Clouds: '‚òÅÔ∏è', Rain: 'üåßÔ∏è', Drizzle: 'üå¶Ô∏è', Thunderstorm: '‚õàÔ∏è',
          Snow: '‚ùÑÔ∏è', Mist: 'üå´Ô∏è', Haze: 'üå´Ô∏è', Fog: 'üå´Ô∏è', Smoke: 'üå´Ô∏è'
        };
        return map[main] || 'üå§Ô∏è';
      }

      capitalize(s=''){ return s.charAt(0).toUpperCase()+s.slice(1); }

      // geolocation
      getCurrentLocation(){
        if (!navigator.geolocation) { this.showError('Geolocation not supported'); return; }
        this.showLoading(); this.hideError();
        navigator.geolocation.getCurrentPosition(pos=>{
          this.getWeatherByCoords(pos.coords.latitude, pos.coords.longitude);
        }, err=>{
          this.hideLoading();
          this.showError('Unable to fetch location ‚Äî permission denied or unavailable.');
        }, { enableHighAccuracy:true, timeout:10000 });
      }
    }

    // ----------------- Init app -----------------
    let app;
    document.addEventListener('DOMContentLoaded', ()=> {
      app = new WeatherMapApp();

      // global small helpers for keyboard accessibility
      document.addEventListener('keydown', (e)=>{
        if(e.key === '/' && document.activeElement !== document.getElementById('cityInput')) {
          e.preventDefault();
          document.getElementById('cityInput').focus();
        }
      });
    });

    // expose for buttons in markup
    window.getWeather = () => app && app.getWeather();
    window.getCurrentLocation = () => app && app.getCurrentLocation();
  </script>
</body>
</html>
